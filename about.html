<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>菜翔翔</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .box{
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 12px;
      background: rgba(0,0,0,.10);
    }
    .muted { color: rgba(232,238,252,.70); }
    .ok { color: #9fe8a7; font-weight: 900; }
    .bad { color: #ffb0b0; font-weight: 900; }
    .small { font-size: 12px; color: rgba(232,238,252,.60); margin-top: 6px; }

    .teamline{
      font-size: 28px;
      font-weight: 900;
      margin: 6px 0 10px;
      letter-spacing: .3px;
    }
    .subline{
      font-size: 14px;
      color: rgba(232,238,252,.72);
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <nav>
    <div class="container nav-inner">
      <div class="brand">MySite</div>
      <div class="nav-links">
        <a href="index.html">首頁</a>
        <a href="about.html">菜翔翔</a>
        <a href="projects.html">麻將計算機</a>
      </div>
    </div>
  </nav>

  <main class="container">
    <section class="hero">
      <h1>菜翔翔</h1>
      <p>進網頁會自動顯示洛杉磯湖人隊最新戰況（中文隊名、台灣時間）。</p>
    </section>

    <section class="grid">
      <div class="card box">
        <div id="out" class="muted">載入中…</div>
        <div id="meta" class="small"></div>
      </div>
    </section>
  </main>

  <footer>
    © <span id="y"></span> MySite
    <script>document.getElementById("y").textContent = new Date().getFullYear();</script>
  </footer>

  <script>
    const TEAM_ABBR = "LAL";
    const TW_TZ = "Asia/Taipei";

    // ESPN 兩個來源（任一可用即可）
    const ESPN_URLS = [
      "https://site.api.espn.com/apis/site/v2/sports/basketball/nba/scoreboard",
      "https://site.web.api.espn.com/apis/site/v2/sports/basketball/nba/scoreboard"
    ];

    // NBA 球隊中文名（abbr -> 中文）
    const TEAM_ZH = {
      ATL:"亞特蘭大老鷹", BOS:"波士頓塞爾提克", BKN:"布魯克林籃網", CHA:"夏洛特黃蜂",
      CHI:"芝加哥公牛", CLE:"克里夫蘭騎士", DAL:"達拉斯獨行俠", DEN:"丹佛金塊",
      DET:"底特律活塞", GSW:"金州勇士", HOU:"休士頓火箭", IND:"印第安納溜馬",
      LAC:"洛杉磯快艇", LAL:"洛杉磯湖人", MEM:"曼菲斯灰熊", MIA:"邁阿密熱火",
      MIL:"密爾瓦基公鹿", MIN:"明尼蘇達灰狼", NOP:"紐奧良鵜鶘", NYK:"紐約尼克",
      OKC:"奧克拉荷馬雷霆", ORL:"奧蘭多魔術", PHI:"費城76人", PHX:"鳳凰城太陽",
      POR:"波特蘭拓荒者", SAC:"沙加緬度國王", SAS:"聖安東尼奧馬刺", TOR:"多倫多暴龍",
      UTA:"猶他爵士", WAS:"華盛頓巫師"
    };

    const out = document.getElementById("out");
    const meta = document.getElementById("meta");

    // 用 LA 日期查 ESPN（資料對齊北美），顯示都用台灣時間
    function laYYYYMMDD(offsetDays = 0) {
      const LA_TZ = "America/Los_Angeles";
      const now = new Date(Date.now() + offsetDays * 86400000);
      const s = new Intl.DateTimeFormat("en-CA", {
        timeZone: LA_TZ, year: "numeric", month: "2-digit", day: "2-digit"
      }).format(now);
      return s.replaceAll("-", "");
    }

    function fmtTW(iso) {
      if (!iso) return "—";
      return new Intl.DateTimeFormat("zh-Hant-TW", {
        timeZone: TW_TZ,
        month: "numeric", day: "numeric",
        hour: "2-digit", minute: "2-digit",
        weekday: "short"
      }).format(new Date(iso));
    }

    async function fetchJson(url) {
      try {
        const r = await fetch(url, { cache: "no-store" });
        if (!r.ok) throw new Error("HTTP " + r.status);
        return await r.json();
      } catch {
        const proxy = "https://api.allorigins.win/raw?url=" + encodeURIComponent(url);
        const r2 = await fetch(proxy, { cache: "no-store" });
        if (!r2.ok) throw new Error("Proxy HTTP " + r2.status);
        return await r2.json();
      }
    }

    function findLakersGame(data) {
      const events = data?.events || [];
      for (const ev of events) {
        const comp = ev?.competitions?.[0];
        const competitors = comp?.competitors || [];
        const hasLAL = competitors.some(c => c?.team?.abbreviation === TEAM_ABBR);
        if (!hasLAL) continue;

        const lal = competitors.find(c => c?.team?.abbreviation === TEAM_ABBR);
        const opp = competitors.find(c => c?.team?.abbreviation !== TEAM_ABBR);
        return { comp, lal, opp };
      }
      return null;
    }

    function zhTeamName(teamObj) {
      const abbr = teamObj?.abbreviation;
      const en = teamObj?.displayName || abbr || "未知隊伍";
      return TEAM_ZH[abbr] || en;
    }

    function render(game) {
      const { comp, lal, opp } = game;

      const state = comp?.status?.type?.state; // pre / in / post
      const completed = !!comp?.status?.type?.completed;

      const leftName = zhTeamName(lal?.team);
      const rightName = zhTeamName(opp?.team);

      const lScore = Number(lal?.score || 0);
      const oScore = Number(opp?.score || 0);

      const startTW = fmtTW(comp?.date);
      const header = `<div class="teamline">${leftName} VS ${rightName}</div>`;

      if (state === "pre") {
        out.innerHTML = `
          ${header}
          <div class="muted">尚未開打</div>
          <div class="subline">台灣開打時間：${startTW}</div>
        `;
        return;
      }

      if (state === "in") {
        out.innerHTML = `
          ${header}
          <div class="muted">進行中：${lScore} - ${oScore}</div>
          <div class="subline">台灣開打時間：${startTW}</div>
        `;
        return;
      }

      if (state === "post" || completed) {
        const win = !!lal?.winner || (lScore > oScore);
        out.innerHTML = `
          ${header}
          <div class="${win ? "ok" : "bad"}">結果：${win ? "贏球" : "輸球"}</div>
          <div class="muted">比分：${lScore} - ${oScore}</div>
          <div class="subline">台灣開打時間：${startTW}</div>
        `;
        return;
      }

      out.innerHTML = `
        ${header}
        <div class="muted">比分：${lScore} - ${oScore}</div>
        <div class="subline">台灣開打時間：${startTW}</div>
      `;
    }

    // 「最新」：先查今天（LA），找不到就查昨天（LA）
    async function loadLatest() {
      out.textContent = "載入中…";
      meta.textContent = "";

      const datesToTry = [laYYYYMMDD(0), laYYYYMMDD(-1)];

      for (const date of datesToTry) {
        for (const base of ESPN_URLS) {
          try {
            const url = `${base}?dates=${date}`;
            const data = await fetchJson(url);
            const game = findLakersGame(data);
            if (game) {
              render(game);
              meta.textContent = "資料更新時間（台灣）： " + new Date().toLocaleString("zh-Hant-TW", { timeZone: TW_TZ });
              return;
            }
          } catch {
            // 換下一個來源/日期
          }
        }
      }

      out.textContent = "找不到湖人的最新比賽資料（可能今天/昨天都沒比賽或資料來源暫時不可用）。";
      meta.textContent = "資料更新時間（台灣）： " + new Date().toLocaleString("zh-Hant-TW", { timeZone: TW_TZ });
    }

    // 進頁面自動載入 + 每 60 秒更新一次
    loadLatest();
    setInterval(loadLatest, 60000);
  </script>
</body>
</html>
