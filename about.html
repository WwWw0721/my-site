<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>菜翔翔</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .wrap { max-width: 860px; margin: 0 auto; }
    .box{
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 12px;
      background: rgba(0,0,0,.10);
    }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap: 10px; flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .muted { color: rgba(232,238,252,.70); }
    .small { font-size: 12px; color: rgba(232,238,252,.60); margin-top: 6px; }

    .btn2{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: #e8eefc;
      cursor: pointer;
      user-select: none;
    }
    .btn2:hover { border-color: rgba(255,255,255,.30); }

    .game{
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 12px;
      background: rgba(0,0,0,.12);
      margin-top: 10px;
    }
    .tag{
      display:inline-block;
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(232,238,252,.85);
      margin-bottom: 8px;
    }

    .matchgrid{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: baseline;
      column-gap: 12px;
    }

    .teamline{
      font-size: 30px;
      font-weight: 900;
      letter-spacing: .3px;
      margin: 2px 0 6px;
      line-height: 1.15;
    }
    .teamL{ text-align:right; }
    .teamR{ text-align:left; }

    .vs{
      color: #6ea8fe;
      font-weight: 950;
      letter-spacing: .6px;
      text-align:center;
      min-width: 40px;
    }

    .scoreline{
      font-size: 36px;
      font-weight: 950;
      letter-spacing: .6px;
      margin: 0 0 6px;
      line-height: 1.05;
    }
    .scoreL{ text-align:right; }
    .scoreR{ text-align:left; }
    .dash{
      text-align:center;
      min-width: 40px;
      opacity: .9;
    }

    .status{
      font-size: 16px;
      font-weight: 800;
      margin: 0 0 6px;
    }
    .ok { color: #9fe8a7; }
    .bad { color: #ffb0b0; }

    .starttime{
      font-size: 22px;
      font-weight: 900;
      color: rgba(232,238,252,.88);
      margin-top: 6px;
    }

    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>
</head>
<body>
  <nav>
    <div class="container nav-inner">
      <div class="brand">MySite</div>
      <div class="nav-links">
        <a href="index.html">首頁</a>
        <a href="about.html">菜翔翔</a>
        <a href="projects.html">麻將計算機</a>
      </div>
    </div>
  </nav>

  <main class="container">
    <section class="hero">
      <h1>菜翔翔</h1>
      <p>湖人最新三場（自動每 15 秒更新，也可手動更新）。</p>
    </section>

    <section class="grid">
      <div class="card box wrap">
        <div class="topbar">
          <div>
            <div style="font-weight:900; font-size:18px;">洛杉磯湖人｜最新三場</div>
            <div class="small" id="meta">—</div>
          </div>
          <button class="btn2" id="refresh">更新</button>
        </div>

        <div id="list" class="muted">載入中…</div>
      </div>
    </section>
  </main>

  <footer>
    © <span id="y"></span> MySite
    <script>document.getElementById("y").textContent = new Date().getFullYear();</script>
  </footer>

  <script>
    const TW_TZ = "Asia/Taipei";
    const TEAM_ID_LAKERS = 13;
    const LAKERS_ABBR = "LAL";

    const SCHEDULE_URLS = [
      `https://site.api.espn.com/apis/site/v2/sports/basketball/nba/teams/${TEAM_ID_LAKERS}/schedule`,
      `https://site.web.api.espn.com/apis/site/v2/sports/basketball/nba/teams/${TEAM_ID_LAKERS}/schedule`
    ];

    const SUMMARY_BASE = "https://site.web.api.espn.com/apis/site/v2/sports/basketball/nba/summary?event=";

    const TEAM_ZH = {
      ATL:"亞特蘭大老鷹",
      BOS:"波士頓塞爾提克",
      BKN:"布魯克林籃網", BRK:"布魯克林籃網",
      CHA:"夏洛特黃蜂", CHO:"夏洛特黃蜂",
      CHI:"芝加哥公牛",
      CLE:"克里夫蘭騎士",
      DAL:"達拉斯獨行俠",
      DEN:"丹佛金塊",
      DET:"底特律活塞",
      GSW:"金州勇士", GS:"金州勇士",
      HOU:"休士頓火箭",
      IND:"印第安納溜馬",
      LAC:"洛杉磯快艇",
      LAL:"洛杉磯湖人",
      MEM:"曼菲斯灰熊",
      MIA:"邁阿密熱火",
      MIL:"密爾瓦基公鹿",
      MIN:"明尼蘇達灰狼",
      NOP:"紐奧良鵜鶘", NO:"紐奧良鵜鶘",
      NYK:"紐約尼克", NY:"紐約尼克",
      OKC:"奧克拉荷馬雷霆",
      ORL:"奧蘭多魔術",
      PHI:"費城76人",
      PHX:"鳳凰城太陽", PHO:"鳳凰城太陽",
      POR:"波特蘭拓荒者",
      SAC:"沙加緬度國王",
      SAS:"聖安東尼奧馬刺", SA:"聖安東尼奧馬刺",
      TOR:"多倫多暴龍",
      UTA:"猶他爵士",
      WAS:"華盛頓巫師", WSH:"華盛頓巫師"
    };

    const listEl = document.getElementById("list");
    const metaEl = document.getElementById("meta");
    const refreshBtn = document.getElementById("refresh");

    function fmtTW(iso) {
      if (!iso) return "—";
      return new Intl.DateTimeFormat("zh-Hant-TW", {
        timeZone: TW_TZ,
        month: "numeric", day: "numeric",
        hour: "2-digit", minute: "2-digit",
        weekday: "short"
      }).format(new Date(iso));
    }

    async function fetchJson(url) {
      try {
        const r = await fetch(url, { cache: "no-store" });
        if (!r.ok) throw new Error("HTTP " + r.status);
        return await r.json();
      } catch {
        const proxy = "https://api.allorigins.win/raw?url=" + encodeURIComponent(url);
        const r2 = await fetch(proxy, { cache: "no-store" });
        if (!r2.ok) throw new Error("Proxy HTTP " + r2.status);
        return await r2.json();
      }
    }

    function zhTeamName(teamObj) {
      const abbr = teamObj?.abbreviation;
      if (abbr && TEAM_ZH[abbr]) return TEAM_ZH[abbr];
      return abbr || "未知隊伍";
    }

    function scoreNum(comp) {
      const s = comp?.score;
      if (s == null) return null;
      if (typeof s === "number") return s;
      if (typeof s === "string") return Number(s);
      if (typeof s === "object") return Number(s.value ?? s.displayValue ?? 0);
      return null;
    }

    function toGameItemFromSchedule(ev) {
      const comp = ev?.competitions?.[0];
      const competitors = comp?.competitors || [];

      const lal = competitors.find(c => c?.team?.abbreviation === LAKERS_ABBR);
      const opp = competitors.find(c => c?.team?.abbreviation !== LAKERS_ABBR);
      if (!lal || !opp) return null;

      const status = comp?.status?.type || {};
      const state = status?.state;
      const completed = !!status?.completed;
      const detail = status?.shortDetail || status?.detail || status?.description || "";

      const lScore = scoreNum(lal);
      const oScore = scoreNum(opp);

      const dateISO = comp?.date || ev?.date;
      const ms = dateISO ? new Date(dateISO).getTime() : 0;

      const eventId = ev?.id || comp?.id || null;

      return {
        eventId,
        date: dateISO,
        ms,
        state: state || (completed ? "post" : ""),
        completed,
        detail,
        lName: zhTeamName(lal.team),
        oName: zhTeamName(opp.team),
        lScore,
        oScore,
        win: !!lal.winner
      };
    }

    function toGameItemFromSummary(baseGame, sum) {
      const comp =
        sum?.header?.competitions?.[0] ||
        sum?.competitions?.[0] ||
        sum?.gamepackageJSON?.header?.competitions?.[0] ||
        null;

      if (!comp) return baseGame;

      const competitors = comp?.competitors || [];
      const lal = competitors.find(c => c?.team?.abbreviation === LAKERS_ABBR);
      const opp = competitors.find(c => c?.team?.abbreviation !== LAKERS_ABBR);
      if (!lal || !opp) return baseGame;

      const status = comp?.status?.type || {};
      const state = status?.state || baseGame.state;
      const completed = !!status?.completed;

      // ✅ 這裡會拿到 "HALFTIME" / "Half" / "Halftime" 等字樣
      const detail = status?.shortDetail || status?.detail || status?.description || baseGame.detail;

      const lScore = scoreNum(lal);
      const oScore = scoreNum(opp);

      const dateISO = comp?.date || baseGame.date;
      const ms = dateISO ? new Date(dateISO).getTime() : baseGame.ms;

      return {
        ...baseGame,
        date: dateISO,
        ms,
        state,
        completed,
        detail,
        lName: zhTeamName(lal.team),
        oName: zhTeamName(opp.team),
        lScore,
        oScore,
        win: !!lal.winner
      };
    }

    async function enrichWithSummary(game) {
      if (!game?.eventId) return game;
      try {
        const sum = await fetchJson(SUMMARY_BASE + encodeURIComponent(game.eventId));
        return toGameItemFromSummary(game, sum);
      } catch {
        return game;
      }
    }

    function pickLatest3(games) {
      const now = Date.now();
      const sorted = games.slice().sort((a,b)=>a.ms-b.ms);

      const inGame = sorted.find(g => g.state === "in");
      if (inGame) {
        const prevFinals = sorted
          .filter(g => (g.completed || g.state === "post") && g.ms < inGame.ms)
          .sort((a,b)=>a.ms-b.ms);
        const last2 = prevFinals.slice(-2).reverse();
        return [inGame, ...last2].slice(0,3);
      }

      const nextPre = sorted
        .filter(g => g.state === "pre" && g.ms >= now)
        .sort((a,b)=>a.ms-b.ms)[0];

      if (nextPre) {
        const prevFinals = sorted
          .filter(g => (g.completed || g.state === "post") && g.ms < now)
          .sort((a,b)=>a.ms-b.ms);
        const last2 = prevFinals.slice(-2).reverse();
        return [nextPre, ...last2].slice(0,3);
      }

      const finals = sorted
        .filter(g => g.completed || g.state === "post")
        .sort((a,b)=>a.ms-b.ms);

      return finals.slice(-3).reverse();
    }

    // ✅ 把 halftime 顯示改成「半場」
    function localizeDetail(detail) {
      if (!detail) return "";
      return String(detail).replace(/halftime/ig, "半場");
    }

    function renderGames(games) {
      if (!games.length) {
        listEl.textContent = "找不到比賽資料。";
        return;
      }

      const labels = ["最新", "前一場", "前二場"];

      listEl.innerHTML = games.map((g, idx) => {
        const twStart = fmtTW(g.date);

        const teamHTML = `
          <div class="matchgrid teamline">
            <div class="teamL">${g.lName}</div>
            <div class="vs">VS</div>
            <div class="teamR">${g.oName}</div>
          </div>
        `;

        let scoreHTML = "";
        if (g.state !== "pre") {
          const L = (g.lScore != null) ? g.lScore : "—";
          const R = (g.oScore != null) ? g.oScore : "—";
          scoreHTML = `
            <div class="matchgrid scoreline">
              <div class="scoreL">${L}</div>
              <div class="dash">-</div>
              <div class="scoreR">${R}</div>
            </div>
          `;
        }

        let timeHTML = "";
        if (g.state === "pre") {
          timeHTML = `<div class="starttime">台灣開打時間：${twStart}</div>`;
        }

        let statusHTML = "";
        if (g.state === "in") {
          const extra = localizeDetail(g.detail);
          statusHTML = `<div class="status muted">進行中${extra ? `（${extra}）` : ""}</div>`;
        } else if (g.state !== "pre") {
          statusHTML = `<div class="status ${g.win ? "ok" : "bad"}">結果：${g.win ? "贏球" : "輸球"}</div>`;
        }

        return `
          <div class="game">
            <div class="tag">${labels[idx] || ""}</div>
            ${teamHTML}
            ${scoreHTML}
            ${statusHTML}
            ${timeHTML}
          </div>
        `;
      }).join("");
    }

    let isLoading = false;

    async function load() {
      if (isLoading) return;
      isLoading = true;

      listEl.textContent = "載入中…";

      for (const url of SCHEDULE_URLS) {
        try {
          const data = await fetchJson(url);
          const events = data?.events || [];
          const games = events.map(toGameItemFromSchedule).filter(Boolean);

          const latest3 = pickLatest3(games);
          const enriched = await Promise.all(latest3.map(enrichWithSummary));

          renderGames(enriched);

          metaEl.innerHTML = `更新時間（台灣）：<span class="mono">${
            new Date().toLocaleString("zh-Hant-TW", { timeZone: TW_TZ })
          }</span>（每 15 秒自動更新）`;

          isLoading = false;
          return;
        } catch (e) {
          // 試下一個 URL
        }
      }

      listEl.textContent = "載入失敗（可能是網路或資料來源暫時不可用）。";
      metaEl.innerHTML = `更新時間（台灣）：<span class="mono">${
        new Date().toLocaleString("zh-Hant-TW", { timeZone: TW_TZ })
      }</span>（每 5 秒自動更新）`;

      isLoading = false;
    }

    refreshBtn.addEventListener("click", load);
    load();
    setInterval(load, 5000);
  </script>
</body>
</html>

