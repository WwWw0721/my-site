<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>菜翔翔</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    button.btn { background: transparent; cursor: pointer; }

    .box{
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 12px;
      background: rgba(0,0,0,.10);
    }
    .muted { color: rgba(232,238,252,.70); }
    .ok { color: #9fe8a7; font-weight: 900; }
    .bad { color: #ffb0b0; font-weight: 900; }
    .small { font-size: 12px; color: rgba(232,238,252,.60); margin-top: 6px; }

    /* 兩隊名字放大 */
    .teamline{
      font-size: 28px;
      font-weight: 900;
      margin: 6px 0 10px;
      letter-spacing: .3px;
    }
    .subline{
      font-size: 14px;
      color: rgba(232,238,252,.72);
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <nav>
    <div class="container nav-inner">
      <div class="brand">MySite</div>
      <div class="nav-links">
        <a href="index.html">首頁</a>
        <a href="about.html">菜翔翔</a>
        <a href="projects.html">麻將計算機</a>
      </div>
    </div>
  </nav>

  <main class="container">
    <section class="hero">
      <h1>菜翔翔</h1>
      <p>查詢洛杉磯湖人隊今天是否贏球、對手、比分（顯示台灣時間）。</p>
      <button class="btn" id="btn">查詢今天</button>
    </section>

    <section class="grid">
      <div class="card box">
        <div id="out" class="muted">尚未查詢</div>
        <div id="meta" class="small"></div>
      </div>
    </section>
  </main>

  <footer>
    © <span id="y"></span> MySite
    <script>document.getElementById("y").textContent = new Date().getFullYear();</script>
  </footer>

  <script>
    const TEAM_ABBR = "LAL";
    const TW_TZ = "Asia/Taipei";

    // ESPN 兩個來源（任一可用即可）
    const ESPN_URLS = [
      "https://site.api.espn.com/apis/site/v2/sports/basketball/nba/scoreboard",
      "https://site.web.api.espn.com/apis/site/v2/sports/basketball/nba/scoreboard"
    ];

    // NBA 球隊中文名（abbr -> 中文）
    const TEAM_ZH = {
      ATL:"亞特蘭大老鷹", BOS:"波士頓塞爾提克", BKN:"布魯克林籃網", CHA:"夏洛特黃蜂",
      CHI:"芝加哥公牛", CLE:"克里夫蘭騎士", DAL:"達拉斯獨行俠", DEN:"丹佛金塊",
      DET:"底特律活塞", GSW:"金州勇士", HOU:"休士頓火箭", IND:"印第安納溜馬",
      LAC:"洛杉磯快艇", LAL:"洛杉磯湖人", MEM:"曼菲斯灰熊", MIA:"邁阿密熱火",
      MIL:"密爾瓦基公鹿", MIN:"明尼蘇達灰狼", NOP:"紐奧良鵜鶘", NYK:"紐約尼克",
      OKC:"奧克拉荷馬雷霆", ORL:"奧蘭多魔術", PHI:"費城76人", PHX:"鳳凰城太陽",
      POR:"波特蘭拓荒者", SAC:"沙加緬度國王", SAS:"聖安東尼奧馬刺", TOR:"多倫多暴龍",
      UTA:"猶他爵士", WAS:"華盛頓巫師"
    };

    const btn = document.getElementById("btn");
    const out = document.getElementById("out");
    const meta = document.getElementById("meta");

    // 用來查「今天」的 scoreboard 日期：ESPN 的 dates 參數常以北美日期對齊；
    // 我們內部仍用 LA 日期去查資料，但顯示一律換成台灣時間。
    function laYYYYMMDD() {
      const LA_TZ = "America/Los_Angeles";
      const s = new Intl.DateTimeFormat("en-CA", {
        timeZone: LA_TZ, year: "numeric", month: "2-digit", day: "2-digit"
      }).format(new Date());
      return s.replaceAll("-", "");
    }

    function fmtTW(iso) {
      if (!iso) return "—";
      return new Intl.DateTimeFormat("zh-Hant-TW", {
        timeZone: TW_TZ,
        month: "numeric", day: "numeric",
        hour: "2-digit", minute: "2-digit",
        weekday: "short"
      }).format(new Date(iso));
    }

    async function fetchJson(url) {
      try {
        const r = await fetch(url, { cache: "no-store" });
        if (!r.ok) throw new Error("HTTP " + r.status);
        return await r.json();
      } catch {
        // fallback：有些環境可能會被 CORS 擋
        const proxy = "https://api.allorigins.win/raw?url=" + encodeURIComponent(url);
        const r2 = await fetch(proxy, { cache: "no-store" });
        if (!r2.ok) throw new Error("Proxy HTTP " + r2.status);
        return await r2.json();
      }
    }

    function findLakersGame(data) {
      const events = data?.events || [];
      for (const ev of events) {
        const comp = ev?.competitions?.[0];
        const competitors = comp?.competitors || [];
        const hasLAL = competitors.some(c => c?.team?.abbreviation === TEAM_ABBR);
        if (!hasLAL) continue;

        const lal = competitors.find(c => c?.team?.abbreviation === TEAM_ABBR);
        const opp = competitors.find(c => c?.team?.abbreviation !== TEAM_ABBR);
        return { comp, lal, opp };
      }
      return null;
    }

    function zhTeamName(teamObj) {
      const abbr = teamObj?.abbreviation;
      const en = teamObj?.displayName || abbr || "未知隊伍";
      return TEAM_ZH[abbr] || en; // 找不到就退回英文
    }

    function render(game) {
      const { comp, lal, opp } = game;

      const state = comp?.status?.type?.state; // pre / in / post
      const completed = !!comp?.status?.type?.completed;

      const lalTeam = lal?.team;
      const oppTeam = opp?.team;

      const leftName = zhTeamName(lalTeam);
      const rightName = zhTeamName(oppTeam);

      const lScore = Number(lal?.score || 0);
      const oScore = Number(opp?.score || 0);

      const startTW = fmtTW(comp?.date);

      // 你要的：XXX VS XXX（中文、放大）
      const header = `<div class="teamline">${leftName} VS ${rightName}</div>`;

      if (state === "pre") {
        out.innerHTML = `
          ${header}
          <div class="muted">尚未開打</div>
          <div class="subline">台灣開打時間：${startTW}</div>
        `;
        return;
      }

      if (state === "in") {
        out.innerHTML = `
          ${header}
          <div class="muted">進行中：${lScore} - ${oScore}</div>
          <div class="subline">台灣開打時間：${startTW}</div>
        `;
        return;
      }

      if (state === "post" || completed) {
        const win = !!lal?.winner || (lScore > oScore);
        out.innerHTML = `
          ${header}
          <div class="${win ? "ok" : "bad"}">結果：${win ? "贏球" : "輸球"}</div>
          <div class="muted">比分：${lScore} - ${oScore}</div>
          <div class="subline">台灣開打時間：${startTW}</div>
        `;
        return;
      }

      out.innerHTML = `
        ${header}
        <div class="muted">比分：${lScore} - ${oScore}</div>
        <div class="subline">台灣開打時間：${startTW}</div>
      `;
    }

    async function checkToday() {
      const date = laYYYYMMDD();
      out.textContent = "查詢中…";
      meta.textContent = "";

      for (const base of ESPN_URLS) {
        try {
          const url = `${base}?dates=${date}`;
          const data = await fetchJson(url);
          const game = findLakersGame(data);

          if (!game) {
            out.textContent = "今天沒有找到湖人的比賽。";
            return;
          }

          render(game);
          return;
        } catch (e) {
          // 換下一個來源
        }
      }

      out.textContent = "查詢失敗（可能是網路或資料來源暫時不可用）。";
    }

    btn.addEventListener("click", checkToday);
  </script>
</body>
</html>
