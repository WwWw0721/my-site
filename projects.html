<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>麻將計算機</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .app { max-width: 760px; margin: 0 auto; }
    .row { display:flex; gap:10px; flex-wrap: wrap; align-items: center; }
    .row > * { flex: 1 1 160px; }

    label { display:block; font-size: 13px; color: rgba(232,238,252,.75); margin: 2px 0 6px; }
    select, input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: #e8eefc;
      outline: none;
    }
    input::placeholder { color: rgba(232,238,252,.35); }

    .actions { display:flex; gap:10px; flex-wrap: wrap; margin-top: 10px; }
    .btn2 {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: #e8eefc;
      cursor: pointer;
      user-select: none;
      text-decoration: none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn2:hover { border-color: rgba(255,255,255,.30); }
    .btn2.primary { background: rgba(110,168,254,.14); }
    .btn2.danger { background: rgba(255,80,80,.12); }

    .chips { display:flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    .chip {
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(232,238,252,.9);
      cursor: pointer;
      user-select: none;
      font-size: 14px;
    }
    .chip:hover { border-color: rgba(255,255,255,.30); }

    .modebar{
      display:flex; gap:10px; flex-wrap:wrap;
      margin: 2px 0 10px;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.10);
    }
    .modebar label{
      margin: 0;
      display:flex; align-items:center; gap:8px;
      font-size: 14px;
      color: rgba(232,238,252,.9);
      cursor:pointer;
      user-select:none;
    }
    .modebar input{ width:auto; }

    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td {
      border-bottom: 1px solid rgba(255,255,255,.12);
      padding: 10px 6px;
      text-align: left;
      font-size: 14px;
    }
    th { color: rgba(232,238,252,.75); font-weight: 600; }
    .pos { color: #9fe8a7; }
    .neg { color: #ffb0b0; }
    .muted { color: rgba(232,238,252,.65); }

    .history {
      margin-top: 12px;
      max-height: 260px;
      overflow: auto;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 10px;
      background: rgba(0,0,0,.12);
    }
    .hitem { padding: 8px 6px; border-bottom: 1px dashed rgba(255,255,255,.12); }
    .hitem:last-child { border-bottom: none; }
    .small { font-size: 12px; color: rgba(232,238,252,.60); margin-top: 6px; }

    .hide { display:none !important; }
  </style>
</head>
<body>
  <nav>
    <div class="container nav-inner">
      <div class="brand">MySite</div>
      <div class="nav-links">
        <a href="index.html">首頁</a>
        <a href="about.html">菜翔翔</a>
        <a href="projects.html">麻將計算機</a>
      </div>
    </div>
  </nav>

  <main class="container">
    <section class="hero">
      <h1>麻將計算機</h1>
      <p>麻將計算機</p>
    </section>

    <section class="grid">
      <div class="card app">

        <!-- 模式選擇 -->
        <div class="modebar">
          <label>
            <input type="radio" name="mode" value="single" checked>
            放槍
          </label>
          <label>
            <input type="radio" name="mode" value="zimo">
            自摸
          </label>
        </div>

        <!-- 單筆模式 -->
        <div id="singlePanel">
          <div class="row">
            <div>
              <label>放槍</label>
              <select id="payer">
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="D">D</option>
              </select>
            </div>
            <div>
              <label>胡牌</label>
              <select id="receiver">
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="D">D</option>
              </select>
            </div>
            <div>
              <label>金額</label>
              <input id="amount" type="number" inputmode="numeric" placeholder="例如 10 或 30" min="1" />
            </div>
          </div>
        </div>

        <!-- 自摸模式 -->
        <div id="zimoPanel" class="hide">
          <div class="row">
            <div>
              <label>自摸</label>
              <select id="winner">
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="D">D</option>
              </select>
            </div>
            <div>
              <label>每家要付的金額</label>
              <input id="zimoAmount" type="number" inputmode="numeric" placeholder="例如 10 或 30" min="1" />
            </div>
            <div>
            </div>
          </div>
        </div>

        <!-- 常用金額 -->
        <div class="chips" aria-label="快速金額">
          <span class="chip" data-amt="10">+10</span>
          <span class="chip" data-amt="30">+30</span>
        </div>

        <div class="actions">
          <button class="btn2 primary" id="add">新增紀錄</button>
          <button class="btn2" id="undo">復原上一步</button>
          <button class="btn2 danger" id="reset">全部重置</button>
        </div>

        <div class="small" id="hint"></div>

        <h3 style="margin:16px 0 6px;">目前差額</h3>
        <table>
          <thead>
            <tr>
              <th>玩家</th>
              <th>差額（+代表贏/收，-代表輸/付）</th>
            </tr>
          </thead>
          <tbody id="score"></tbody>
        </table>

        <h3 style="margin:16px 0 6px;">紀錄</h3>
        <div class="history" id="history"></div>
        <div class="small">提示：單筆/自摸都可以輸入金額後按 Enter 直接新增。</div>
      </div>
    </section>
  </main>

  <footer>© <span id="y"></span> MySite
    <script>document.getElementById("y").textContent = new Date().getFullYear();</script>
  </footer>

  <script>
    const PLAYERS = ["A", "B", "C", "D"];
    const KEY = "mahjong_chip_calc_v2"; // v2：加入自摸紀錄格式

    // UI
    const singlePanel = document.getElementById("singlePanel");
    const zimoPanel = document.getElementById("zimoPanel");
    const payerSel = document.getElementById("payer");
    const receiverSel = document.getElementById("receiver");
    const amountInp = document.getElementById("amount");
    const winnerSel = document.getElementById("winner");
    const zimoAmountInp = document.getElementById("zimoAmount");

    const hint = document.getElementById("hint");
    const scoreBody = document.getElementById("score");
    const historyBox = document.getElementById("history");

    function defaultState() {
      const balances = {};
      PLAYERS.forEach(p => balances[p] = 0);
      return { balances, history: [] };
    }

    // 兼容你舊版 localStorage（如果有）
    function loadState() {
      try {
        const raw = localStorage.getItem(KEY);
        if (raw) {
          const obj = JSON.parse(raw);
          if (obj && obj.balances && obj.history) return obj;
        }
      } catch {}

      // 嘗試讀舊 key（v1）
      try {
        const old = localStorage.getItem("mahjong_chip_calc_v1");
        if (old) {
          const obj = JSON.parse(old);
          if (obj && obj.balances && obj.history) {
            // 舊紀錄一律視為單筆
            const converted = {
              balances: obj.balances,
              history: (obj.history || []).map(h => ({
                type: "single",
                payer: h.payer,
                receiver: h.receiver,
                amount: h.amount,
                ts: h.ts
              }))
            };
            localStorage.setItem(KEY, JSON.stringify(converted));
            return converted;
          }
        }
      } catch {}

      return defaultState();
    }

    let state = loadState();

    function saveState() {
      localStorage.setItem(KEY, JSON.stringify(state));
    }

    function fmt(n) {
      const sign = n > 0 ? "+" : "";
      return sign + n;
    }

    function renderScores() {
      scoreBody.innerHTML = PLAYERS.map(p => {
        const v = state.balances[p] || 0;
        const cls = v > 0 ? "pos" : (v < 0 ? "neg" : "muted");
        return `<tr><td>${p}</td><td class="${cls}">${fmt(v)}</td></tr>`;
      }).join("");

      const sum = PLAYERS.reduce((acc,p)=>acc+(state.balances[p]||0), 0);
      hint.textContent = `檢查：四人總和 = ${sum}（正常應為 0）`;
    }

    function renderHistory() {
      if (!state.history || state.history.length === 0) {
        historyBox.innerHTML = `<div class="muted">尚無紀錄</div>`;
        return;
      }

      historyBox.innerHTML = state.history.slice().reverse().map((h) => {
        const t = new Date(h.ts).toLocaleString();
        if (h.type === "zimo") {
          return `<div class="hitem">
            <div><b>自摸</b>：<b>${h.winner}</b> 收 <span class="muted">${h.amount}</span> × 3（其他三家各付）</div>
            <div class="small">${t}</div>
          </div>`;
        } else {
          return `<div class="hitem">
            <div><b>${h.payer}</b> → <b>${h.receiver}</b>　<span class="muted">${h.amount}</span></div>
            <div class="small">${t}</div>
          </div>`;
        }
      }).join("");
    }

    function addSingle(payer, receiver, amount) {
      if (!PLAYERS.includes(payer) || !PLAYERS.includes(receiver)) return;
      if (payer === receiver) { hint.textContent = "付款者與收款者不能相同。"; return; }
      if (!Number.isFinite(amount) || amount <= 0) { hint.textContent = "金額請輸入正整數。"; return; }

      state.balances[payer] = (state.balances[payer] || 0) - amount;
      state.balances[receiver] = (state.balances[receiver] || 0) + amount;

      state.history.push({ type: "single", payer, receiver, amount, ts: Date.now() });
      saveState();
      renderScores();
      renderHistory();
      hint.textContent = "已新增（單筆）。";
    }

    // 自摸：三家各付 amount 給 winner
    function addZimo(winner, amount) {
      if (!PLAYERS.includes(winner)) return;
      if (!Number.isFinite(amount) || amount <= 0) { hint.textContent = "金額請輸入正整數。"; return; }

      for (const p of PLAYERS) {
        if (p === winner) continue;
        state.balances[p] = (state.balances[p] || 0) - amount;
        state.balances[winner] = (state.balances[winner] || 0) + amount;
      }

      state.history.push({ type: "zimo", winner, amount, ts: Date.now() });
      saveState();
      renderScores();
      renderHistory();
      hint.textContent = "已新增（自摸）。";
    }

    function undo() {
      const last = state.history.pop();
      if (!last) { hint.textContent = "沒有可以復原的紀錄。"; return; }

      if (last.type === "zimo") {
        const winner = last.winner;
        const amount = last.amount;

        for (const p of PLAYERS) {
          if (p === winner) continue;
          state.balances[p] = (state.balances[p] || 0) + amount;
          state.balances[winner] = (state.balances[winner] || 0) - amount;
        }
      } else {
        const payer = last.payer;
        const receiver = last.receiver;
        const amount = last.amount;

        state.balances[payer] = (state.balances[payer] || 0) + amount;
        state.balances[receiver] = (state.balances[receiver] || 0) - amount;
      }

      saveState();
      renderScores();
      renderHistory();
      hint.textContent = "已復原上一步。";
    }

    function resetAll() {
      state = defaultState();
      saveState();
      renderScores();
      renderHistory();
      hint.textContent = "已重置。";
    }

    function getMode() {
      const checked = document.querySelector('input[name="mode"]:checked');
      return checked ? checked.value : "single";
    }

    function applyModeUI() {
      const mode = getMode();
      if (mode === "zimo") {
        singlePanel.classList.add("hide");
        zimoPanel.classList.remove("hide");
        zimoAmountInp.focus();
      } else {
        zimoPanel.classList.add("hide");
        singlePanel.classList.remove("hide");
        amountInp.focus();
      }
      hint.textContent = "";
    }

    // Mode change
    document.querySelectorAll('input[name="mode"]').forEach(r => {
      r.addEventListener("change", applyModeUI);
    });

    // Add
    document.getElementById("add").addEventListener("click", () => {
      const mode = getMode();
      if (mode === "zimo") {
        const winner = winnerSel.value;
        const amount = parseInt(zimoAmountInp.value, 10);
        addZimo(winner, amount);
        zimoAmountInp.focus();
        zimoAmountInp.select();
      } else {
        const payer = payerSel.value;
        const receiver = receiverSel.value;
        const amount = parseInt(amountInp.value, 10);
        addSingle(payer, receiver, amount);
        amountInp.focus();
        amountInp.select();
      }
    });

    document.getElementById("undo").addEventListener("click", undo);
    document.getElementById("reset").addEventListener("click", resetAll);

    // 快速金額：加到目前模式的金額框
    document.querySelectorAll(".chip").forEach(chip => {
      chip.addEventListener("click", () => {
        const add = parseInt(chip.dataset.amt, 10);
        const mode = getMode();
        const target = (mode === "zimo") ? zimoAmountInp : amountInp;

        const cur = parseInt(target.value || "0", 10);
        target.value = String((Number.isFinite(cur) ? cur : 0) + add);
        target.focus();
      });
    });

    // Enter 快速新增
    function bindEnter(inp) {
      inp.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          document.getElementById("add").click();
        }
        if (e.key === "Escape") {
          e.preventDefault();
          inp.value = "";
          hint.textContent = "";
        }
      });
    }
    bindEnter(amountInp);
    bindEnter(zimoAmountInp);

    // init
    payerSel.value = "A";
    receiverSel.value = "B";
    winnerSel.value = "B";
    applyModeUI();
    renderScores();
    renderHistory();
  </script>
</body>
</html>

